name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - prod
  pull_request:
    branches:
      - main
      - prod

jobs:
  # Job –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ (–ª–∏–Ω—Ç–µ—Ä—ã, —Ç–µ—Å—Ç—ã, typecheck)
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint

      - name: Check code formatting
        run: npm run format:check

      - name: Type check
        run: npm run typecheck
        continue-on-error: true

      - name: Run tests
        run: npm run test:run

  # Job –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ prod (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ç–∫–∏ prod)
  deploy-prod:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/prod'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Deploy to hosting
        run: |
          echo "üöÄ Deploying to production hosting..."
          echo "Build completed successfully!"
          echo "üìÅ Build artifacts are in .output/public/"
          echo "üí° Configure your hosting to serve files from .output/public/"

          # –ó–¥–µ—Å—å –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ –≤–∞—à —Ö–æ—Å—Ç–∏–Ω–≥
          # –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è FTP/SFTP –¥–µ–ø–ª–æ—è:
          # - name: Deploy via FTP
          #   uses: SamKirkland/FTP-Deploy-Action@4.3.4
          #   with:
          #     server: ${{ secrets.FTP_SERVER }}
          #     username: ${{ secrets.FTP_USERNAME }}
          #     password: ${{ secrets.FTP_PASSWORD }}
          #     local-dir: .output/public/
          #     server-dir: /public_html/
